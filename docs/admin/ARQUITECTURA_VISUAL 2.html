<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura del Sistema de AdministraciÃ³n - Visual</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        nav {
            background: #f8f9fa;
            padding: 1rem 2rem;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        nav button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        nav button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        nav button.active {
            background: #667eea;
            color: white;
            border-color: #764ba2;
        }
        
        .content {
            padding: 2rem;
        }
        
        .diagram-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .diagram-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .diagram-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
        }
        
        .diagram-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .diagram-description {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .mermaid {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        
        .info-box h3 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .info-box ul {
            margin-left: 1.5rem;
            color: #555;
        }
        
        .info-box li {
            margin: 0.5rem 0;
        }
        
        .legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .legend-color.presentation { background: #667eea; }
        .legend-color.api { background: #48bb78; }
        .legend-color.business { background: #ed8936; }
        .legend-color.data { background: #9f7aea; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ—ï¸ Arquitectura del Sistema de AdministraciÃ³n</h1>
            <p>VisualizaciÃ³n interactiva de la arquitectura completa</p>
        </header>
        
        <nav>
            <button class="active" onclick="showDiagram('overview')">ğŸ“Š Vista General</button>
            <button onclick="showDiagram('layers')">ğŸ›ï¸ Capas</button>
            <button onclick="showDiagram('dataflow')">ğŸ”„ Flujos de Datos</button>
            <button onclick="showDiagram('modules')">ğŸ§© MÃ³dulos</button>
            <button onclick="showDiagram('security')">ğŸ” Seguridad</button>
            <button onclick="showDiagram('components')">ğŸ¨ Componentes</button>
        </nav>
        
        <div class="content">
            <!-- Vista General -->
            <div id="overview" class="diagram-section active">
                <div class="diagram-container">
                    <div class="diagram-title">ğŸ“Š Arquitectura General del Sistema</div>
                    <div class="diagram-description">
                        Vista de alto nivel mostrando todas las capas del sistema de administraciÃ³n y cÃ³mo interactÃºan entre sÃ­.
                    </div>
                    <div class="mermaid">
graph TB
    subgraph "Cliente"
        Browser[ğŸŒ Navegador]
        AdminUI[ğŸ“± Admin UI<br/>Next.js App Router]
    end
    
    subgraph "Middleware"
        AuthMW[ğŸ” Middleware<br/>AutenticaciÃ³n]
        RateLimit[â±ï¸ Rate Limiting]
    end
    
    subgraph "API Layer"
        AdminAPI[ğŸ”Œ API Routes<br/>/api/admin/*]
        StatsAPI[ğŸ“Š Stats API]
        BuildingsAPI[ğŸ¢ Buildings API]
        UnitsAPI[ğŸ  Units API]
        FlagsAPI[ğŸš© Flags API]
    end
    
    subgraph "Business Logic"
        AdminLib[ğŸ“š lib/admin/*]
        AuthLib[ğŸ”‘ Auth Utils]
        DataLib[ğŸ’¾ Data Utils]
        CSVLib[ğŸ“„ CSV Utils]
    end
    
    subgraph "Data Layer"
        Supabase[(ğŸ—„ï¸ Supabase<br/>PostgreSQL)]
        FileSystem[ğŸ“ File System<br/>JSON Files]
    end
    
    Browser --> AdminUI
    AdminUI --> AuthMW
    AuthMW --> RateLimit
    RateLimit --> AdminAPI
    AdminAPI --> AdminLib
    AdminLib --> AuthLib
    AdminLib --> DataLib
    AdminLib --> CSVLib
    DataLib --> Supabase
    DataLib --> FileSystem
    AdminAPI --> StatsAPI
    AdminAPI --> BuildingsAPI
    AdminAPI --> UnitsAPI
    AdminAPI --> FlagsAPI
                    </div>
                    
                    <div class="info-box">
                        <h3>ğŸ’¡ Componentes Clave</h3>
                        <ul>
                            <li><strong>Cliente:</strong> Interfaz de usuario construida con Next.js 14 App Router</li>
                            <li><strong>Middleware:</strong> ProtecciÃ³n de rutas y rate limiting</li>
                            <li><strong>API Layer:</strong> Endpoints RESTful para todas las operaciones</li>
                            <li><strong>Business Logic:</strong> LÃ³gica de negocio reutilizable</li>
                            <li><strong>Data Layer:</strong> Supabase (producciÃ³n) y File System (desarrollo)</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Capas -->
            <div id="layers" class="diagram-section">
                <div class="diagram-container">
                    <div class="diagram-title">ğŸ›ï¸ Arquitectura en Capas</div>
                    <div class="diagram-description">
                        DescomposiciÃ³n detallada de cada capa del sistema y sus responsabilidades.
                    </div>
                    <div class="mermaid">
graph TB
    subgraph "Capa 1: PresentaciÃ³n"
        Pages[ğŸ“± Pages RSC]
        Components[ğŸ§© Components Client]
        Hooks[ğŸ£ Hooks State]
    end
    
    subgraph "Capa 2: API"
        Routes[ğŸ”Œ Route Handlers]
        Middleware[ğŸ›¡ï¸ Middleware]
    end
    
    subgraph "Capa 3: Business Logic"
        AuthLogic[ğŸ” Auth Logic]
        DataLogic[ğŸ’¾ Data Logic]
        CSVLogic[ğŸ“„ CSV Logic]
    end
    
    subgraph "Capa 4: Data"
        Database[(ğŸ—„ï¸ Database)]
        Files[ğŸ“ Files]
    end
    
    Pages --> Components
    Components --> Hooks
    Hooks --> Routes
    Routes --> Middleware
    Middleware --> AuthLogic
    Middleware --> DataLogic
    AuthLogic --> Database
    DataLogic --> Database
    DataLogic --> Files
    CSVLogic --> Files
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color presentation"></div>
                            <span>Capa de PresentaciÃ³n</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color api"></div>
                            <span>Capa de API</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color business"></div>
                            <span>LÃ³gica de Negocio</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color data"></div>
                            <span>Capa de Datos</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Flujos de Datos -->
            <div id="dataflow" class="diagram-section">
                <div class="diagram-container">
                    <div class="diagram-title">ğŸ”„ Flujo: Crear Edificio (CRUD)</div>
                    <div class="diagram-description">
                        Secuencia completa de una operaciÃ³n CRUD tÃ­pica, mostrando el flujo desde el formulario hasta la base de datos.
                    </div>
                    <div class="mermaid">
sequenceDiagram
    participant Form as ğŸ“ BuildingForm
    participant Hook as ğŸ£ useCreateBuilding
    participant API as ğŸ”Œ /api/admin/buildings
    participant Validator as âœ… Zod Validator
    participant DataLib as ğŸ’¾ Data Lib
    participant DB as ğŸ—„ï¸ Supabase

    Form->>Hook: createBuilding({ building })
    Hook->>Hook: Optimistic update
    Hook->>API: POST /api/admin/buildings
    API->>Validator: Validar schema
    Validator-->>API: ValidaciÃ³n OK/Error
    
    alt ValidaciÃ³n OK
        API->>DataLib: createBuilding(building)
        DataLib->>DB: INSERT INTO buildings
        DB-->>DataLib: New building
        DataLib-->>API: Building object
        API-->>Hook: Success response
        Hook->>Hook: Invalidar queries
        Hook->>Form: Success toast
    else ValidaciÃ³n Error
        API-->>Hook: 400 Error
        Hook->>Hook: Revertir optimistic update
        Hook->>Form: Error toast
    end
                    </div>
                </div>
                
                <div class="diagram-container">
                    <div class="diagram-title">ğŸ”„ Flujo: AutenticaciÃ³n</div>
                    <div class="diagram-description">
                        Proceso de autenticaciÃ³n y verificaciÃ³n de acceso al panel de administraciÃ³n.
                    </div>
                    <div class="mermaid">
sequenceDiagram
    participant User as ğŸ‘¤ Usuario
    participant Browser as ğŸŒ Navegador
    participant MW as ğŸ›¡ï¸ Middleware
    participant Auth as ğŸ” Auth Lib
    participant Page as ğŸ“± Admin Page

    User->>Browser: Accede a /admin
    Browser->>MW: Request GET /admin
    MW->>Auth: Verificar token (header/cookie)
    Auth-->>MW: Token vÃ¡lido/invÃ¡lido
    
    alt Token vÃ¡lido
        MW->>Page: Permitir acceso
        Page-->>Browser: Renderizar dashboard
        Browser-->>User: Mostrar panel admin
    else Token invÃ¡lido
        MW->>Browser: Redirect /admin/login
        Browser-->>User: Mostrar login
    end
                    </div>
                </div>
            </div>
            
            <!-- MÃ³dulos -->
            <div id="modules" class="diagram-section">
                <div class="diagram-container">
                    <div class="diagram-title">ğŸ§© MÃ³dulos Principales</div>
                    <div class="diagram-description">
                        Estructura modular del sistema de administraciÃ³n y sus interrelaciones.
                    </div>
                    <div class="mermaid">
graph TB
    subgraph "Dashboard Module"
        Dashboard[ğŸ“Š Dashboard]
        Stats[ğŸ“ˆ Stats]
    end
    
    subgraph "Buildings Module"
        Buildings[ğŸ¢ Buildings]
        BuildingForm[ğŸ“ Form]
        BuildingTable[ğŸ“‹ Table]
    end
    
    subgraph "Units Module"
        Units[ğŸ  Units]
        UnitForm[ğŸ“ Form]
        UnitTable[ğŸ“‹ Table]
    end
    
    subgraph "Flags Module"
        Flags[ğŸš© Flags]
        FlagToggle[ğŸ”˜ Toggle]
    end
    
    subgraph "Completeness Module"
        Completeness[âœ… Completeness]
        Analysis[ğŸ“Š Analysis]
    end
    
    Dashboard --> Stats
    Dashboard --> Buildings
    Dashboard --> Units
    Dashboard --> Flags
    Dashboard --> Completeness
    
    Buildings --> BuildingForm
    Buildings --> BuildingTable
    Units --> UnitForm
    Units --> UnitTable
    Flags --> FlagToggle
    Completeness --> Analysis
                    </div>
                    
                    <div class="info-box">
                        <h3>ğŸ“¦ MÃ³dulos Disponibles</h3>
                        <ul>
                            <li><strong>Dashboard:</strong> Vista general con mÃ©tricas y accesos rÃ¡pidos</li>
                            <li><strong>Buildings:</strong> GestiÃ³n completa de edificios (CRUD)</li>
                            <li><strong>Units:</strong> GestiÃ³n completa de unidades (CRUD)</li>
                            <li><strong>Flags:</strong> Control de feature flags y overrides</li>
                            <li><strong>Completeness:</strong> AnÃ¡lisis de completitud de datos</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Seguridad -->
            <div id="security" class="diagram-section">
                <div class="diagram-container">
                    <div class="diagram-title">ğŸ” Arquitectura de Seguridad</div>
                    <div class="diagram-description">
                        Flujo de seguridad y autenticaciÃ³n del sistema.
                    </div>
                    <div class="mermaid">
graph LR
    A[Request] --> B{Es ruta protegida?}
    B -->|No| C[âœ… Permitir acceso]
    B -->|SÃ­| D{Token presente?}
    D -->|No| E[âŒ 401 Unauthorized]
    D -->|SÃ­| F{Token vÃ¡lido?}
    F -->|No| E
    F -->|SÃ­| G{Rate limit OK?}
    G -->|No| H[â±ï¸ 429 Too Many Requests]
    G -->|SÃ­| C
                    </div>
                    
                    <div class="info-box">
                        <h3>ğŸ›¡ï¸ Medidas de Seguridad</h3>
                        <ul>
                            <li><strong>Middleware Protection:</strong> Todas las rutas /admin/* estÃ¡n protegidas</li>
                            <li><strong>Token Authentication:</strong> VerificaciÃ³n de token en header o cookie</li>
                            <li><strong>Rate Limiting:</strong> 20 requests por 60 segundos por IP</li>
                            <li><strong>ValidaciÃ³n:</strong> Zod validation en todos los endpoints</li>
                            <li><strong>Error Handling:</strong> Respuestas seguras sin exponer informaciÃ³n sensible</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Componentes -->
            <div id="components" class="diagram-section">
                <div class="diagram-container">
                    <div class="diagram-title">ğŸ¨ Componentes Interactivos</div>
                    <div class="diagram-description">
                        RelaciÃ³n entre componentes de la UI y cÃ³mo interactÃºan entre sÃ­.
                    </div>
                    <div class="mermaid">
graph TB
    subgraph "Admin Dashboard"
        Dashboard[ğŸ“Š Dashboard Page]
        Stats[ğŸ“ˆ Stats Cards]
        QuickActions[âš¡ Quick Actions]
    end
    
    subgraph "Buildings Module"
        BuildingsPage[ğŸ¢ Buildings Page]
        BuildingForm[ğŸ“ Building Form]
        BuildingTable[ğŸ“‹ Data Table]
        BuildingFilters[ğŸ” Filters]
    end
    
    subgraph "Units Module"
        UnitsPage[ğŸ  Units Page]
        UnitForm[ğŸ“ Unit Form]
        UnitTable[ğŸ“‹ Data Table]
    end
    
    subgraph "Shared Components"
        SearchBar[ğŸ” Search Bar]
        BulkActions[ğŸ“¦ Bulk Actions]
        ImportDialog[ğŸ“¥ Import Dialog]
        ExportDialog[ğŸ“¤ Export Dialog]
        ErrorBoundary[âš ï¸ Error Boundary]
    end
    
    Dashboard --> Stats
    Dashboard --> QuickActions
    QuickActions --> BuildingsPage
    QuickActions --> UnitsPage
    
    BuildingsPage --> BuildingForm
    BuildingsPage --> BuildingTable
    BuildingsPage --> BuildingFilters
    BuildingsPage --> SearchBar
    BuildingsPage --> BulkActions
    BuildingsPage --> ImportDialog
    BuildingsPage --> ExportDialog
    
    UnitsPage --> UnitForm
    UnitsPage --> UnitTable
    UnitsPage --> SearchBar
    UnitsPage --> BulkActions
    
    BuildingsPage --> ErrorBoundary
    UnitsPage --> ErrorBoundary
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#764ba2',
                lineColor: '#667eea',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#e9ecef'
            }
        });
        
        function showDiagram(diagramId) {
            // Ocultar todos los diagramas
            document.querySelectorAll('.diagram-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover clase active de todos los botones
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar el diagrama seleccionado
            document.getElementById(diagramId).classList.add('active');
            
            // Activar el botÃ³n correspondiente
            event.target.classList.add('active');
        }
    </script>
</body>
</html>









